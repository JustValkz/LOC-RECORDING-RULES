# --- ASCII Art Header in Cyan ---
Write-Host @"
| |   |  _  /  __ \ | ___ \  ___/  __ \  _  | ___ \  _  \_   _| \ | |  __ \ | ___ \  _  | |   |_   _/  __ \ \ / /
| |   | | | | /  \/ | |_/ / |__ | /  \/ | | | |_/ / | | | | | |  \| | |  \/ | |_/ / | | | |     | | | /  \/\ V /
| |   | | | | |     |    /|  __|| |   | | | |    /| | | | | | | .  | | __  |  __/| | | | |     | | | |     \ /
| |___\ \_/ / \__/\ | |\ \| |___| \__/\ \_/ / |\ \| |/ / _| |_| |\  | |_\ \ | |   \ \_/ / |_____| |_| \__/\ | |
\_____/\___/ \____/ \_| \_\____/ \____/\___/\_| \_|___/  \___/\_| \_/\____/ \_|    \___/\_____/\___/ \____/ \_/
Made by @yusuf.quadri | discord.gg/locx / discord.gg/locjd
Tier 1 Recording Policy 
"@ -ForegroundColor Cyan 

# --- Instruction Block ---
Write-Host ""
Write-Host "Must ensure that result is SUCCESS and follow instructions to ensure a valid recording." -ForegroundColor Yellow 
Write-Host "You have 24H to send your recording in the JD Server." -ForegroundColor Yellow
Write-Host ""
Write-Host "Press Enter to continue..." -ForegroundColor Cyan
[void][System.Console]::ReadLine()
Clear-Host

# --- Section 1: Memory + Defender + Threats + GPU ---
Write-Host "--- Memory Integrity ---" -ForegroundColor White
$memIntegrityPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity'
$memIntegrity = Get-ItemProperty -Path $memIntegrityPath -Name "Enabled" -ErrorAction SilentlyContinue

if ($memIntegrity.Enabled -eq 1) {
    Write-Host "SUCCESS: Memory Integrity supported." -ForegroundColor Green
    Write-Host "SUCCESS: Memory Integrity is ON." -ForegroundColor Green
} else {
    Write-Host "FAIL: Memory Integrity unsupported or OFF." -ForegroundColor Red
}

# --- Windows Defender Checks ---
Write-Host "--- Windows Defender ---" -ForegroundColor White
$realTimeDisabled = (Get-MpPreference).DisableRealtimeMonitoring
if ($realTimeDisabled) {
    Write-Host "FAIL: Realtime protection is OFF." -ForegroundColor Red
} else {
    Write-Host "SUCCESS: Realtime protection is ON." -ForegroundColor Green
}

# --- Exclusions ---
Write-Host "--- Exclusions ---" -ForegroundColor White
$excl = @()
$pref = Get-MpPreference
if ($pref.ExclusionProcess) { $excl += $pref.ExclusionProcess }
if ($pref.ExclusionPath) { $excl += $pref.ExclusionPath }
if ($pref.ExclusionExtension) { $excl += $pref.ExclusionExtension }

$registryExcl = @()
$exclusionRegistryPaths = @(
    'HKLM:\SOFTWARE\Microsoft\Windows Defender\Exclusions\TemporaryPaths',
    'HKLM:\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths',
    'HKLM:\SOFTWARE\Microsoft\Windows Defender\Exclusions\Processes'
)

foreach ($regPath in $exclusionRegistryPaths) {
    try {
        $item = Get-Item -Path $regPath -ErrorAction Stop
        $baseKey = $item.PSPath -replace '^Microsoft.PowerShell.Core\\Registry::', ''
        $rawKey = [Microsoft.Win32.Registry]::LocalMachine.OpenSubKey($baseKey.Substring(5))
        if ($rawKey) {
            $valueNames = $rawKey.GetValueNames()
            foreach ($name in $valueNames) {
                $val = $rawKey.GetValue($name)
                if ([string]::IsNullOrEmpty($val)) {
                    $registryExcl += $name
                } else {
                    $registryExcl += "$name : $val"
                }
            }
            $rawKey.Close()
        }
    } catch {}
}

if ($registryExcl.Count -gt 0) { $excl += $registryExcl }
$excl = $excl | Sort-Object -Unique
if ($excl.Count -eq 0) {
    Write-Host "SUCCESS: No Defender exclusions set." -ForegroundColor Green
} else {
    Write-Host "WARNING: Defender exclusions are set." -ForegroundColor Yellow
    foreach ($e in $excl) { Write-Host " - $e" -ForegroundColor Yellow }
}

# --- Allowed Threats ---
Write-Host "--- Allowed Threats ---" -ForegroundColor White
$allowedThreats = Get-MpThreatDetection | Where-Object {
    ($_.ThreatStatus -eq "Allowed" -or $_.ThreatStatus -eq "AllowedByUser") -and
    ($_.Resources -and $_.Resources.Count -gt 0)
}
if (!$allowedThreats -or $allowedThreats.Count -eq 0) {
    Write-Host "SUCCESS: No active allowed threats." -ForegroundColor Green
} else {
    Write-Host "WARNING: Active allowed threats detected!" -ForegroundColor Red
    $allowedThreats | ForEach-Object {
        Write-Host " - $($_.ThreatName) / Status: $($_.ThreatStatus)" -ForegroundColor Red
    }
}

# --- Restored Threats & GPU Check ---
Write-Host "--- Restored Threats (past 7 days) & GPU Check ---" -ForegroundColor White
$sevenDaysAgo = (Get-Date).AddDays(-7)
try {
    $events = Get-WinEvent -FilterHashtable @{
        LogName   = 'Microsoft-Windows-Windows Defender/Operational'
        StartTime = $sevenDaysAgo
    } -ErrorAction Stop
} catch {
    Write-Host "ERROR: Could not access Defender event log. Run as Administrator?" -ForegroundColor Red
    exit
}

$restoredThreats = @()
foreach ($event in $events) {
    $xml = [xml]$event.ToXml()
    $eventID = $xml.Event.System.EventID
    if ($eventID -eq 1009 -or $xml.InnerXml -like "*restored*") {
        $threatName = $xml.Event.EventData.Data |
            Where-Object { $_.Name -match 'ThreatName|Name' } |
            Select-Object -ExpandProperty '#text' -ErrorAction SilentlyContinue
        if ($threatName) { $restoredThreats += $threatName } else { $restoredThreats += $event.Message }
    }
}

if ($restoredThreats.Count -eq 0) {
    Write-Host "SUCCESS: No restored threats in the past 7 days." -ForegroundColor Green
} else {
    Write-Host "WARNING: Restored threats found in the past 7 days:" -ForegroundColor Yellow
    $restoredThreats | Sort-Object -Unique | ForEach-Object { Write-Host " - $_" -ForegroundColor Yellow }
}

# --- GPU Info ---
try {
    $gpu = Get-CimInstance Win32_VideoController | Select-Object -First 1
    $gpuName = $gpu.Name
    Write-Host "Detected GPU: $gpuName" -ForegroundColor Green
} catch {
    Write-Host "No GPU detected or error retrieving info." -ForegroundColor Green
}

# --- Pause before Section 2 ---
Write-Host ""
Write-Host "Press Enter to continue to Section 2..." -ForegroundColor Cyan
[void][System.Console]::ReadLine()
Clear-Host

# --- Section 2 Header & List ---
Write-Host "=== SECTION 2 ===" -ForegroundColor Cyan
Write-Host "Sections:" -ForegroundColor White
Write-Host "1. Memory & Defender Checks (Completed)" -ForegroundColor Green
Write-Host "2. Registry Check, Prefetch & Resource Monitor (Current)" -ForegroundColor Yellow
Write-Host ""

# --- Section 2: Registry Check ---
function Show-RegistryKey {
    param (
      [string]$RegPath,
      [string]$PromptMessage = "Press Enter to Continue..."
    )
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Applets\Regedit" -Name "LastKey" -Value $RegPath
    Start-Process regedit.exe
    Write-Host "NOTE: Full screen and **Scroll all the way down**!" -ForegroundColor Yellow
    Write-Host $PromptMessage -ForegroundColor Cyan
    [void][System.Console]::ReadLine()
}

Write-Host "=== Registry Check ===" -ForegroundColor Cyan
Show-RegistryKey -RegPath "Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions"
Show-RegistryKey -RegPath "Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Processes"
Show-RegistryKey -RegPath "Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\TemporaryPaths"
Show-RegistryKey -RegPath "Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths"
Show-RegistryKey -RegPath "Computer\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FeatureUsage\AppSwitched"
Show-RegistryKey -RegPath "Computer\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FeatureUsage\ShowJumpView"

Clear-Host

# --- Prefetch Recent Executions ---
$prefetchPath = "$env:SystemRoot\Prefetch"
$cutoffTime = (Get-Date).AddHours(-24)
$prefetchFiles = Get-ChildItem -Path $prefetchPath -Filter *.pf -ErrorAction SilentlyContinue

$recentExecutions = @()
foreach ($file in $prefetchFiles) {
    $lastRunTime = $file.LastAccessTime
    if ($lastRunTime -ge $cutoffTime) {
        $exeName = $file.BaseName -replace "-.*", ".exe"
        $hoursAgo = [math]::Round(((Get-Date) - $lastRunTime).TotalHours, 2)
        $recentExecutions += [PSCustomObject]@{
            ExeName     = $exeName
            LastRunTime = $lastRunTime
            HoursAgo    = $hoursAgo
        }
    }
}

if ($recentExecutions.Count -eq 0) {
    Write-Host "No recent prefetch executions in the last 24 hours." -ForegroundColor Green
} else {
    Write-Host "--- Recent Prefetch Executions (last 24 hours) ---" -ForegroundColor White
    foreach ($entry in $recentExecutions | Sort-Object LastRunTime) {
        Write-Output "$($entry.ExeName) | Last Run: $($entry.LastRunTime) | $($entry.HoursAgo) hours ago"
    }
}

Write-Host "Press Enter to continue to Resource Monitor..." -ForegroundColor Cyan
[void][System.Console]::ReadLine()
Clear-Host

# --- Open Resource Monitor ---
Write-Host "--- Resource Monitor ---" -ForegroundColor Cyan
$perfmonPath = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Administrative Tools\Resource Monitor.lnk"
if (Test-Path $perfmonPath) {
    Start-Process $perfmonPath
    Write-Host "Launching Resource Monitor..." -ForegroundColor Green
    Write-Host "NOTE: **Full screen**, navigate to **Overview** and scroll all the way down, then navigate to **CPU** and scroll all the way down." -ForegroundColor Yellow
} else {
    Write-Host "ERROR: Could not find Resource Monitor shortcut." -ForegroundColor Red
}

Write-Host "Press Enter to finish the script..." -ForegroundColor Cyan
[void][System.Console]::ReadLine()
Write-Host "Powershell Script finished" -ForegroundColor Green
